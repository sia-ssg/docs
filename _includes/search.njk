<div class="search-wrapper">
  <button class="search-toggle" aria-label="Search">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"></circle>
      <path d="m21 21-4.35-4.35"></path>
    </svg>
  </button>
  <div class="search-modal" id="search-modal">
    <div class="search-modal-content">
      <div class="search-input-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="search" id="search-input" placeholder="Search documentation..." autocomplete="off">
        <button class="search-close" aria-label="Close search">Ã—</button>
      </div>
      <div class="search-results" id="search-results"></div>
    </div>
  </div>
</div>

<script>
  (function() {
    let searchIndex = [];
    
    // Load search index
    fetch('{{ "/assets/search-index.json" | url }}')
      .then(res => res.json())
      .then(data => {
        searchIndex = data;
      })
      .catch(() => {
        console.warn('Search index not available');
      });
    
    const searchModal = document.getElementById('search-modal');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const searchToggle = document.querySelector('.search-toggle');
    const searchClose = document.querySelector('.search-close');
    
    function openSearch() {
      searchModal.classList.add('active');
      searchInput.focus();
      document.body.style.overflow = 'hidden';
    }
    
    function closeSearch() {
      searchModal.classList.remove('active');
      searchInput.value = '';
      searchResults.innerHTML = '';
      document.body.style.overflow = '';
    }
    
    searchToggle?.addEventListener('click', openSearch);
    searchClose?.addEventListener('click', closeSearch);
    
    searchModal?.addEventListener('click', function(e) {
      if (e.target === searchModal) {
        closeSearch();
      }
    });
    
    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }
      if (e.key === 'Escape' && searchModal.classList.contains('active')) {
        closeSearch();
      }
    });
    
    function search(query) {
      if (!query.trim() || searchIndex.length === 0) {
        searchResults.innerHTML = '';
        return;
      }
      
      const queryLower = query.toLowerCase();
      const results = searchIndex
        .filter(item => {
          const titleMatch = item.title.toLowerCase().includes(queryLower);
          const contentMatch = item.content.toLowerCase().includes(queryLower);
          return titleMatch || contentMatch;
        })
        .slice(0, 10);
      
      if (results.length === 0) {
        searchResults.innerHTML = '<div class="search-no-results">No results found</div>';
        return;
      }
      
      searchResults.innerHTML = results.map(item => `
        <a href="${item.url}" class="search-result-item">
          <div class="search-result-title">${highlight(item.title, query)}</div>
          <div class="search-result-excerpt">${highlight(item.excerpt || '', query)}</div>
        </a>
      `).join('');
    }
    
    function highlight(text, query) {
      if (!query) return text;
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }
    
    let searchTimeout;
    searchInput?.addEventListener('input', function(e) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        search(e.target.value);
      }, 150);
    });
  })();
</script>

